#  (TE) 故障检测实验报告（PCA baseline）

摘要
---------
在 21 类故障上的平均检测率 ≈ 0.6384（63.84%）。多数故障能被有效检测（若干接近 100%），但存在数个难以检测或检测延迟大的故障（d03、d09、d15 等）。

一、数据概述
-----------
- 数据集：22 组文件，d00 为正常数据，d01..d21 为 21 种故障。
- 每文件维度：961 × 52（52 个测量变量，文件无表头，空格分隔）。
- 故障区间：对于故障文件（d01..d21），样本索引 161 开始出现故障，评估时只关注区间 161..960（共 800 个样本）。
- 采样间隔：3 分钟（若需将样本延迟换算为时间，delay_minutes = delay_samples * 3）。

二、方法概述（使用的算法与原理）
----------------------------

### 2.1 PCA异常检测的基本思想

主成分分析（PCA）是一种降维技术，它能从高维数据中提取最重要的变化模式。对于本实验的52维测量数据，PCA可以找到10个最关键的"方向"（主成分），这些方向能够解释数据的大部分变化。将52维数据压缩到10维主成分（丢弃不重要的信息）再从10维还原回52维（重构）对于正常数据：压缩-重构后误差很小（因为模型在正常数据上训练）；对于故障数据：压缩-重构后误差变大

### 2.2 实现步骤详解

本次基线选用 PCA（主成分分析）重构误差作为异常分数，步骤如下：

1. **标准化（StandardScaler）**
对训练（正常）数据每个特征做零均值单位方差归一化，保证各特征尺度一致。


2. **PCA 建模** 在标准化后的正常数据上拟合 PCA，保留若干主成分（实验使用n_components=10）。将数据投影到低维主成分空间，再逆投影得到重构值。


3. **重构误差（reconstruction error）** 每个样本的重构误差定义为所有特征均方误差（MSE）：$\text{mean}[(x - x_{rec})^2]$

4. **阈值确定** 在训练（正常）数据的重构误差上使用百分位法设阈（默认 99%）。若误差 > 阈值则判定为"告警"（异常）

### 2.3 方法优点与局限性

**优点：**
- 实现简洁、计算效率高、对高维数据常能提取主要变化模式。
- 对某些突变或明显偏离的故障效果很好（如d01、d06、d07、d14）。
- 无需标注故障类型，只需正常数据即可训练。

**局限：**
- PCA 假设主要变化方向能代表"正常"，但某些故障可能仅影响少数变量或以小幅逐步漂移表现，导致重构误差不显著。
- 阈值选择对检测率与误报率敏感，需要根据应用场景调整。

- **不建模时间依赖关系**（逐样本独立处理），对逐步累积或慢漂故障不敏感（如d18、d20）。
- 对于与正常模式相似的故障（如d03、d09、d15）检测效果差。

三、实验设置
-----------
- **训练集**：使用 `d00_te.dat` 的全部样本（0..960）来训练标准化器与 PCA。
- **测试集**：对每一个故障文件（d01..d21），将所有样本标准化后计算重构误差并与阈值比较，统计评估区间 161..960 的检测情况。
- **阈值**：默认采用训练重构误差的第 99 百分位数作为阈值（可配置）。
- **主成分数量**：n_components=10（保留10个主成分）
- **输出**：
  - 对每个故障计算 detection_rate = (# 告警样本在 161..960) / 800（或实际样本数）。
  - 记录首次检测索引（若在评估区间内没有告警则记为 None）与延迟（样本数）。

四、实验结果（检测率表）
-----------------------
下表为 `output/detection_results_pca.csv` 中记录的结果（针对样本 161..960）：

| fault_file | fault_id | detection_rate | detected_count | num_fault_samples | first_detect_idx | delay_samples |
|---:|---|---:|---:|---:|---:|---:|
| d01_te.dat | d01 | 0.9975 | 797 | 799 | 163 | 3 |
| d02_te.dat | d02 | 0.9862 | 788 | 799 | 172 | 12 |
| d03_te.dat | d03 | 0.0325 | 26  | 799 | 180 | 20 |
| d04_te.dat | d04 | 0.9887 | 790 | 799 | 162 | 2 |
| d05_te.dat | d05 | 0.2703 | 216 | 799 | 161 | 1 |
| d06_te.dat | d06 | 1.0000 | 799 | 799 | 161 | 1 |
| d07_te.dat | d07 | 1.0000 | 799 | 799 | 161 | 1 |
| d08_te.dat | d08 | 0.9737 | 778 | 799 | 179 | 19 |
| d09_te.dat | d09 | 0.0225 | 18  | 799 | 224 | 64 |
| d10_te.dat | d10 | 0.2453 | 196 | 799 | 186 | 26 |
| d11_te.dat | d11 | 0.7171 | 573 | 799 | 165 | 5 |
| d12_te.dat | d12 | 0.9625 | 769 | 799 | 162 | 2 |
| d13_te.dat | d13 | 0.9549 | 763 | 799 | 196 | 36 |
| d14_te.dat | d14 | 1.0000 | 799 | 799 | 161 | 1 |
| d15_te.dat | d15 | 0.0263 | 21  | 799 | 237 | 77 |
| d16_te.dat | d16 | 0.2128 | 170 | 799 | 171 | 11 |
| d17_te.dat | d17 | 0.9249 | 739 | 799 | 184 | 24 |
| d18_te.dat | d18 | 0.9036 | 722 | 799 | 220 | 60 |
| d19_te.dat | d19 | 0.2541 | 203 | 799 | 170 | 10 |
| d20_te.dat | d20 | 0.4793 | 383 | 799 | 242 | 82 |
| d21_te.dat | d21 | 0.4543 | 363 | 799 | 173 | 13 |

**整体指标：**
- **平均检测率**（21 faults）≈ **0.6384（63.84%）**
- **高检测率故障**（>95%）：d01, d02, d04, d06, d07, d08, d12, d13, d14, d17, d18（11个）
- **低检测率故障**（<30%）：d03, d05, d09, d10, d15, d16, d19（7个）
- **中等检测率故障**（30-95%）：d11, d20, d21（3个）

五、可视化结果详解
----------------

### 5.1 检测率柱状图（detection_rates_pca.png）

**图表说明：**
- 横轴：21种故障类型（d01-d21）
- 纵轴：检测率（0-1之间，1表示100%）
- 每根柱子的高度：该故障被成功检测到的比例

**关键观察：**
1. **高柱子（接近1.0）**：如d01, d02, d06, d07, d14
   - 检测率接近100%，说明这些故障特征明显
   - PCA模型能轻松识别这些故障导致的数据偏离
   
2. **低柱子（接近0）**：如d03, d09, d15
   - 检测率低于5%，说明这些故障模式与正常数据太相似
   - PCA难以区分，可能需要其他方法（如时序模型）
   
3. **中等柱子**：如d11, d20, d21
   - 检测率在40-70%之间
   - 说明故障有一定特征，但不够显著或存在延迟

**整体结论**：PCA方法对不同故障类型的检测能力差异很大，不是所有故障都适合用PCA检测。

### 5.2 时间线图1：d06_te.dat（检测率100%，最佳案例）

**图表元素说明：**
- **蓝色曲线**：重构误差随时间（样本序号）的变化
- **黑色虚线**：故障开始点（第161个样本）
- **红色竖线**：触发告警的位置（误差超过阈值）

**关键观察：**
- **故障前（0-160）**：重构误差接近0，非常稳定（正常数据重构效果好）
- **故障后（161-960）**：
  - 误差立即飙升（从0跳到600+）
  - 持续保持高位，无明显波动
  - 红色告警线几乎完全覆盖整个故障区间

**结论：**
这是**理想的检测结果**。故障发生后立即被识别（延迟仅1个样本=3分钟），持续告警无误报或漏报。这种故障导致系统数据大幅偏离正常模式，PCA完全能够捕捉。

**为什么d06检测效果这么好？**
根据TE过程文档，d06是"物料A的进料损失"故障，这会导致多个相关变量（进料流量、反应器压力、成分浓度等）同时发生显著变化，这种多维度的明显偏离正是PCA擅长检测的。

### 5.3 时间线图2：d09_te.dat（检测率2.3%，最差案例）

**关键观察：**
- **整个过程**：重构误差一直在0.2-1.0之间剧烈波动
- **故障前后**：误差水平基本一致，看不出明显区别
- **红色告警点**：零星出现，无规律，主要是正常波动触发的误报

**结论：**
这是**PCA完全失效的案例**。故障的模式与正常数据太相似，PCA无法区分。误差波动是数据本身的特性（可能是随机变量类型的故障），不是故障导致的。偶尔的告警只是误报，不代表真正检测到故障。

**为什么d09检测效果这么差？**
根据TE过程文档，d09是"物料D的进料温度随机变量"故障。这种随机波动型故障的特征是：
1. 变化幅度小，逐渐累积
2. 随机性强，与正常波动相似
3. 主要影响动态特性，而不是瞬时测量值

PCA是基于单样本重构误差的静态方法，无法捕捉这种时间序列上的渐变特征。

### 5.4 时间线图3：d18_te.dat（检测率90.4%，延迟案例）

**关键观察：**
- **故障前（0-160）**：误差接近0
- **故障后（161-960）**：
  - 误差**缓慢上升**，不是突变
  - 约在第400个样本后才稳定在高位（500+）
  - 告警延迟明显：从161（故障开始）到220（首次告警）约**60个样本=3小时**

**结论：**
这是**"慢性故障"的典型表现**。故障影响逐渐累积，重构误差需要时间才能超过阈值。虽然最终检测率高（90%），但存在较长的检测延迟。在工业应用中，3小时的延迟可能已经造成损失。

**为什么d18有延迟？**
根据TE过程文档，d18是"未知"类型故障。从时间线看，这可能是一种渐进式故障（如催化剂失活、换热器结垢等），影响需要时间累积才能在测量数据中体现。

**对比三个案例的启示：**
- d06（突变型故障）：PCA最适合
- d09（随机波动型故障）：PCA不适合，需要时序方法
- d18（渐进型故障）：PCA能检测，但有延迟

六、结果分析与讨论
-----------------

### 6.1 检测成功的故障（高检测率）
- **d01, d02, d04, d06, d07, d08, d12, d13, d14, d17, d18**：这些故障在 PCA 重构误差上表现明显，说明它们导致系统变量发生显著偏离正常子空间，PCA 能有效捕获。
- **特点分析**：
  - 多数为阶跃型故障（step change），变化突然且幅度大
  - 影响多个关键测量变量
  - 首次检测索引靠近故障起点（delay_samples 小），说明突变式故障容易被重构误差捕获

### 6.2 检测效果差的故障（低检测率或极低）
- **d03 (3.25%)、d09 (2.25%)、d15 (2.63%)**：检测率极低，说明这些故障在被训练的 PCA 模型所捕获的主成分空间中并不突出。

**可能原因：**
1. **故障影响的量测变量较少且振幅小**：只影响52个变量中的少数几个
2. **故障表现为缓慢漂移**：渐变型故障在单样本上不明显
3. **与正常变化方向相似**：故障导致的变化方向恰好在PCA学习到的主成分方向上
4. **随机变量型故障**（如d09）：体现为过程动力学（时间序列相关）变化，而非瞬时观测值的异常

**改进建议：**
- 时间窗口特征：使用滑动窗口统计特征（均值、方差、趋势）
- 序列建模：LSTM-AE、1D-CNN 捕捉时间依赖关系
- 统计过程控制：CUSUM、EWMA 方法检测渐变
- 多模型集成：结合PCA（检测突变）+ 时序模型（检测渐变）

### 6.3 延迟较大的情况
- **d20（延迟82样本=246分钟≈4.1小时）、d15（延迟77样本）、d18（延迟60样本）**：即使最终被检测到也存在明显延迟，可能为逐步累积型故障。

**工业影响：**
延迟对工业在线检测影响较大。例如4小时的延迟可能意味着：
- 产品质量已经受影响
- 能源浪费增加
- 设备磨损加剧
- 维修成本上升

**解决方向：**
- 降低阈值（代价是误报率上升，需权衡）
- 使用动态阈值（考虑误差变化趋势，而非绝对值）
- 引入早期预警机制（在误差上升趋势阶段就告警）

### 6.4 误报与阈值敏感性
- **当前设置**：阈值采用训练集 99 百分位，控制误报率≈1%
- **权衡问题**：
  - 阈值太高：漏报增加（如d09、d15难以检测）
  - 阈值太低：误报增加（正常波动被当作故障）

**优化建议：**
1. **ROC曲线分析**：绘制不同阈值下的误报率-检测率曲线，找到最佳平衡点
2. **动态阈值**：根据运行状态自适应调整（如启动阶段vs稳定运行）
3. **置信度评分**：不仅给出二元判断（是/否异常），还提供异常置信度


七、附录：重要数值说明
--------------------

### 7.1 延迟换算
- **delay_samples → delay_minutes** = delay_samples × 3
- 示例：
  - d20: delay_samples = 82 → delay_minutes = 246分钟 ≈ 4.1小时
  - d18: delay_samples = 60 → delay_minutes = 180分钟 = 3小时
  - d06: delay_samples = 1 → delay_minutes = 3分钟（近乎实时）

### 7.2 检测率分布
- **优秀（>95%）**：11个故障
- **良好（70-95%）**：3个故障（d11, d17, d18）
- **中等（30-70%）**：2个故障（d20, d21）
- **较差（10-30%）**：2个故障（d05, d10, d16, d19）
- **极差（<10%）**：3个故障（d03, d09, d15）

### 7.3 指标
- **平均检测率**：63.84%
- **中位检测率**：72.10%（说明分布不均，有明显的高低分化）
- **最佳检测**：d06, d07, d14（100%）
- **最差检测**：d09（2.25%）

九、结论
--------

本实验使用PCA重构误差方法作为TE过程异常检测的baseline，得出以下结论：

1. **整体表现**：平均检测率63.84%，对于无监督方法来说是可接受的起点。

2. **适用性分析**：
   - PCA对突变型、多变量关联型故障（如d06, d07）表现优异（100%检测率）
   - 对随机波动型、渐变型、局部变量故障（如d03, d09, d15）效果差（<5%检测率）

3. **实际应用考量**：
   - 优点：实现简单、计算快、无需标注数据
   - 限制：检测延迟（最长4小时）、漏报率高（某些故障）
   - 建议：作为快速筛查工具，配合其他方法形成多层检测体系